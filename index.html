<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iShip Print Pro - Smooth Sharp</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { --primary-color: #ff6b00; }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 20px; text-align: center; margin: 0; }
        .card { background: white; max-width: 500px; margin: auto; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .app-logo { width: 60px; height: 60px; margin-bottom: 10px; border-radius: 12px; }
        .upload-area { border: 3px dashed var(--primary-color); padding: 30px; border-radius: 15px; cursor: pointer; background: #fff9f5; margin-bottom: 20px; }
        
        #pdfWrapper { 
            position: relative; display: none; margin: 15px 0; border: 2px solid #ccc; 
            line-height: 0; touch-action: none; user-select: none; overflow: hidden;
        }
        #displayCanvas { width: 100%; height: auto; }
        #selectionBox { 
            position: absolute; border: 2px solid #ff0000; background: rgba(255, 0, 0, 0.1); 
            display: none; pointer-events: none; box-sizing: border-box;
        }
        
        .controls { text-align: left; background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        button { padding: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        .btn-process { background: var(--primary-color); color: white; }
        .btn-share { background: #28a745; color: white; display: none; }
        #previewCanvas { width: 100%; border: 1px solid #333; margin-top: 20px; display: none; }
    </style>
</head>
<body>

<div class="card">
    <img src="https://cdn-icons-png.flaticon.com/512/446/446991.png" alt="Logo" class="app-logo">
    <h2 style="margin-top:0; color: var(--primary-color);">iShip Print Fix üöÄ</h2>
    <p id="status" style="font-size: 13px;">‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö PDF ‡πÅ‡∏•‡∏∞ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)</p>

    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" accept="application/pdf, image/*" style="display:none">
        <strong>üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</strong>
    </div>

    <div id="pdfWrapper">
        <canvas id="displayCanvas"></canvas>
        <div id="selectionBox"></div>
    </div>

    <div class="controls">
        <label style="font-size:12px; font-weight: bold;">‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô (‡∏Å‡∏£‡∏ì‡∏µ‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏≤‡∏ß):</label>
        <input type="number" id="splitCount" value="1" min="1" max="5" style="width:100%; padding:10px; box-sizing:border-box; margin-top:5px;">
    </div>

    <button class="btn-process" onclick="processSmoothSharp()">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏á)</button>
    <button id="shareBtn" class="btn-share" onclick="shareToPrinter()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>

    <canvas id="previewCanvas"></canvas>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    
    let currentSource = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (Image ‡∏´‡∏£‡∏∑‡∏≠ Canvas)
    let displayCanvas = document.getElementById('displayCanvas');
    let selectionBox = document.getElementById('selectionBox');
    let pdfWrapper = document.getElementById('pdfWrapper');
    let finalBlob = null;
    let isDrawing = false, startX, startY;

    function getMousePos(e) {
        const rect = displayCanvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const scaleX = displayCanvas.width / rect.width;
        const scaleY = displayCanvas.height / rect.height;
        return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
    }

    const startSelection = (e) => {
        isDrawing = true;
        const pos = getMousePos(e);
        startX = pos.x; startY = pos.y;
        selectionBox.style.display = "block";
    };

    const moveSelection = (e) => {
        if (!isDrawing) return;
        const currentPos = getMousePos(e);
        const rect = displayCanvas.getBoundingClientRect();
        const sX = rect.width / displayCanvas.width;
        const sY = rect.height / displayCanvas.height;
        selectionBox.style.left = `${Math.min(startX, currentPos.x) * sX}px`;
        selectionBox.style.top = `${Math.min(startY, currentPos.y) * sY}px`;
        selectionBox.style.width = `${Math.abs(startX - currentPos.x) * sX}px`;
        selectionBox.style.height = `${Math.abs(startY - currentPos.y) * sY}px`;
    };

    pdfWrapper.addEventListener('mousedown', startSelection);
    window.addEventListener('mousemove', moveSelection);
    window.addEventListener('mouseup', () => isDrawing = false);
    pdfWrapper.addEventListener('touchstart', (e) => { startSelection(e); e.preventDefault(); }, {passive: false});
    window.addEventListener('touchmove', (e) => { moveSelection(e); }, {passive: false});
    window.addEventListener('touchend', () => isDrawing = false);

    document.getElementById('fileInput').onchange = async function() {
        const file = this.files[0];
        if (!file) return;

        if (file.type === "application/pdf") {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            const page = await pdf.getPage(1);
            const viewport = page.getViewport({ scale: 1.5 });
            displayCanvas.width = viewport.width;
            displayCanvas.height = viewport.height;
            await page.render({ canvasContext: displayCanvas.getContext('2d'), viewport: viewport }).promise;
            currentSource = page; // ‡πÄ‡∏Å‡πá‡∏ö page ‡πÑ‡∏ß‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• HD ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á
        } else if (file.type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    displayCanvas.width = img.width;
                    displayCanvas.height = img.height;
                    displayCanvas.getContext('2d').drawImage(img, 0, 0);
                    currentSource = img; // ‡πÄ‡∏Å‡πá‡∏ö‡∏†‡∏≤‡∏û‡πÑ‡∏ß‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
        
        pdfWrapper.style.display = "inline-block";
        selectionBox.style.display = "none";
    };

    async function processSmoothSharp() {
        if (!currentSource || selectionBox.style.display === 'none') return;
        document.getElementById('status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏á...";

        const rect = displayCanvas.getBoundingClientRect();
        const boxLeft = parseFloat(selectionBox.style.left) / rect.width;
        const boxTop = parseFloat(selectionBox.style.top) / rect.height;
        const boxW = parseFloat(selectionBox.style.width) / rect.width;
        const boxH = parseFloat(selectionBox.style.height) / rect.height;

        let hdCanvas = document.createElement('canvas');
        
        if (currentSource.getViewport) { // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô PDF
            const hdScale = 8.0;
            const hdViewport = currentSource.getViewport({ scale: hdScale });
            hdCanvas.width = hdViewport.width;
            hdCanvas.height = hdViewport.height;
            await currentSource.render({ canvasContext: hdCanvas.getContext('2d'), viewport: hdViewport }).promise;
        } else { // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            hdCanvas.width = currentSource.width;
            hdCanvas.height = currentSource.height;
            hdCanvas.getContext('2d').drawImage(currentSource, 0, 0);
        }

        const cropX = hdCanvas.width * boxLeft;
        const cropY = hdCanvas.height * boxTop;
        const cropW = hdCanvas.width * boxW;
        const cropH = hdCanvas.height * boxH;

        const splitCount = parseInt(document.getElementById('splitCount').value) || 1;
        const partH = cropH / splitCount;

        const previewCanvas = document.getElementById('previewCanvas');
        const pCtx = previewCanvas.getContext('2d');

        previewCanvas.width = partH; 
        previewCanvas.height = cropW * splitCount;

        pCtx.filter = 'contrast(1.4) grayscale(1)';

        for (let i = 0; i < splitCount; i++) {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = partH; tempCanvas.height = cropW;
            const tCtx = tempCanvas.getContext('2d');
            tCtx.translate(tempCanvas.width/2, tempCanvas.height/2);
            tCtx.rotate(-90 * Math.PI / 180);
            tCtx.drawImage(hdCanvas, cropX, cropY + (i * partH), cropW, partH, -cropW/2, -partH/2, cropW, partH);
            pCtx.drawImage(tempCanvas, 0, i * cropW);
        }

        pCtx.filter = 'none';
        previewCanvas.style.display = "inline-block";
        document.getElementById('shareBtn').style.display = "block";
        document.getElementById('status').innerText = "‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡πÅ‡∏ö‡∏ö High-Res";
        previewCanvas.toBlob(blob => { finalBlob = blob; }, 'image/png');
    }

    async function shareToPrinter() {
        if (!finalBlob) return;
        const file = new File([finalBlob], "label.png", { type: "image/png" });
        if (navigator.share) {
            navigator.share({ files: [file], title: 'iShip Print' });
        } else {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(finalBlob);
            link.download = "label.png";
            link.click();
        }
    }
</script>
</body>
</html>