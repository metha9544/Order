<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iShip Print Fix</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="iShipPrint">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/446/446991.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/446/446991.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <style>
        :root { --primary-color: #ff6b00; } /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏™‡πâ‡∏°‡πÅ‡∏ö‡∏ö iShip */
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 20px; text-align: center; }
        .card { background: white; max-width: 500px; margin: auto; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
        .app-logo { width: 60px; height: 60px; margin-bottom: 10px; border-radius: 12px; }
        
        .upload-area { border: 3px dashed var(--primary-color); padding: 30px; border-radius: 15px; cursor: pointer; margin-bottom: 20px; background: #fff9f5; }
        #pdfWrapper { position: relative; display: inline-block; margin: 15px 0; border: 2px solid #ccc; max-width: 100%; display: none; line-height: 0; }
        #selectionBox { position: absolute; border: 3px solid #ff0000; background: rgba(255, 0, 0, 0.15); cursor: move; width: 100%; height: 200px; box-sizing: border-box; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; text-align: left; background: #f9f9f9; padding: 15px; border-radius: 10px; }
        button { padding: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; transition: 0.2s; }
        .btn-process { background: var(--primary-color); color: white; }
        .btn-process:active { transform: scale(0.98); }
        .btn-share { background: #28a745; color: white; margin-top: 15px; display: none; }
        #previewCanvas { width: 150px; border: 2px solid #333; margin-top: 20px; display: none; background: white; }
    </style>
</head>
<body>

<div class="card">
    <img src="https://cdn-icons-png.flaticon.com/512/446/446991.png" alt="Logo" class="app-logo">
    <h2 style="margin-top:0; color: var(--primary-color);">iShip Print Fix</h2>
    <p style="font-size: 13px; color: #666;">‡∏ï‡∏±‡∏î‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà ‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö HD</p>

    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" accept="application/pdf" style="display:none">
        <strong>üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤</strong>
    </div>

    <div id="pdfWrapper">
        <canvas id="displayCanvas"></canvas>
        <div id="selectionBox"></div>
    </div>

    <div class="controls">
        <div>
            <label style="font-size:12px; font-weight: bold;">‡∏´‡∏±‡πà‡∏ô‡∏Å‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô:</label>
            <input type="number" id="splitCount" value="2" min="1" max="5" style="width:90%; padding:8px; border-radius: 5px; border:1px solid #ddd;">
        </div>
        <div>
            <label style="font-size:12px; font-weight: bold;">‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏£‡∏≠‡∏ö:</label>
            <input type="range" id="boxHeightInput" min="50" max="1000" value="350">
        </div>
    </div>

    <button class="btn-process" onclick="processUltraSharp()">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</button>
    <button id="shareBtn" class="btn-share" onclick="shareToPrinter()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>

    <div id="status" style="margin-top:15px; font-weight:bold; color:var(--primary-color);"></div>
    <canvas id="previewCanvas"></canvas>
</div>

<script>
    // --- JavaScript ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    
    let currentPdf = null;
    let displayCanvas = document.getElementById('displayCanvas');
    let selectionBox = document.getElementById('selectionBox');
    let finalBlob = null;
    let displayScale = 1.0;

    let isDragging = false;
    let startY, startTop;

    const startDrag = (e) => {
        isDragging = true;
        startY = e.clientY || e.touches[0].clientY;
        startTop = selectionBox.offsetTop;
    };
    const moveDrag = (e) => {
        if (!isDragging) return;
        const clientY = e.clientY || e.touches[0].clientY;
        let newTop = startTop + (clientY - startY);
        newTop = Math.max(0, Math.min(newTop, displayCanvas.offsetHeight - selectionBox.offsetHeight));
        selectionBox.style.top = newTop + "px";
        if(e.cancelable) e.preventDefault();
    };
    
    selectionBox.addEventListener('mousedown', startDrag);
    selectionBox.addEventListener('touchstart', startDrag);
    window.addEventListener('mousemove', moveDrag);
    window.addEventListener('touchmove', moveDrag, {passive: false});
    window.addEventListener('mouseup', () => isDragging = false);
    window.addEventListener('touchend', () => isDragging = false);

    document.getElementById('boxHeightInput').oninput = function() {
        selectionBox.style.height = this.value + "px";
    };

    document.getElementById('fileInput').onchange = async function() {
        const file = this.files[0];
        if (!file) return;
        const arrayBuffer = await file.arrayBuffer();
        currentPdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        const page = await currentPdf.getPage(1);
        const viewport = page.getViewport({ scale: 1.2 });
        displayScale = 1.2;
        displayCanvas.width = viewport.width;
        displayCanvas.height = viewport.height;
        await page.render({ canvasContext: displayCanvas.getContext('2d'), viewport: viewport }).promise;
        document.getElementById('pdfWrapper').style.display = "inline-block";
        document.getElementById('status').innerText = "‡∏ß‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏î‡∏á‡∏ó‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£";
    };

    async function processUltraSharp() {
        if (!currentPdf) return;
        const status = document.getElementById('status');
        const splitCount = parseInt(document.getElementById('splitCount').value);
        status.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏á...";

        const page = await currentPdf.getPage(1);
        const hdScale = 6.0;
        const hdViewport = page.getViewport({ scale: hdScale });
        const hdCanvas = document.createElement('canvas');
        const hdCtx = hdCanvas.getContext('2d', { alpha: false });
        hdCanvas.width = hdViewport.width;
        hdCanvas.height = hdViewport.height;

        await page.render({ canvasContext: hdCtx, viewport: hdViewport, intent: 'print' }).promise;

        const ratio = hdScale / displayScale;
        const cropY = selectionBox.offsetTop * ratio;
        const cropH = selectionBox.offsetHeight * ratio;
        const cropW = hdCanvas.width;
        const partW = cropW;
        const partH = cropH / splitCount;

        const resultCanvas = document.getElementById('previewCanvas');
        const rCtx = resultCanvas.getContext('2d');
        resultCanvas.width = partH;
        resultCanvas.height = partW * splitCount;
        rCtx.imageSmoothingEnabled = true;
        rCtx.imageSmoothingQuality = 'high';

        for (let i = 0; i < splitCount; i++) {
            const piece = document.createElement('canvas');
            const pCtx = piece.getContext('2d');
            piece.width = partH; piece.height = partW;
            pCtx.translate(piece.width/2, piece.height/2);
            pCtx.rotate(-90 * Math.PI / 180);
            pCtx.drawImage(hdCanvas, 0, cropY + (i * partH), partW, partH, -partW/2, -partH/2, partW, partH);
            rCtx.drawImage(piece, 0, i * partW);
        }

        resultCanvas.toBlob((blob) => {
            finalBlob = blob;
            status.innerText = "‚úÖ ‡∏Ñ‡∏°‡∏Å‡∏£‡∏¥‡∏ö! ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á";
            resultCanvas.style.display = "inline-block";
            document.getElementById('shareBtn').style.display = "block";
        }, 'image/png', 1.0);
    }

    async function shareToPrinter() {
        const file = new File([finalBlob], "label_hd.png", { type: "image/png" });
        if (navigator.share) {
            await navigator.share({ files: [file], title: 'Print Label HD' });
        } else {
            const link = document.createElement('a');
            link.download = "label_hd.png"; link.href = URL.createObjectURL(finalBlob); link.click();
        }
    }
</script>

</body>
</html>
