<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra-Sharp Mini Printer Splitter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; text-align: center; }
        .card { background: white; max-width: 500px; margin: auto; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .upload-area { border: 3px dashed #007bff; padding: 30px; border-radius: 15px; cursor: pointer; margin-bottom: 20px; background: #f8fbff; }
        #pdfWrapper { position: relative; display: inline-block; margin: 15px 0; border: 2px solid #ccc; max-width: 100%; display: none; line-height: 0; }
        #selectionBox { position: absolute; border: 3px solid #ff0000; background: rgba(255, 0, 0, 0.15); cursor: move; left: 0; top: 0; width: 100%; height: 200px; box-sizing: border-box; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; text-align: left; background: #f9f9f9; padding: 15px; border-radius: 10px; }
        button { padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; transition: 0.2s; }
        .btn-process { background: #007bff; color: white; }
        .btn-process:active { transform: scale(0.98); }
        .btn-share { background: #28a745; color: white; margin-top: 15px; display: none; }
        #previewCanvas { width: 150px; border: 2px solid #333; margin-top: 20px; display: none; background: white; }
        input[type="range"] { width: 100%; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="margin-top:0;">üíé ‡∏Ñ‡∏°‡∏Å‡∏£‡∏¥‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå</h2>
    <p style="font-size: 13px; color: #666;">‡∏•‡∏≤‡∏Å‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏î‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏≠‡∏≤ <br>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏ï‡∏±‡∏î</p>

    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" accept="application/pdf" style="display:none">
        <strong>üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF</strong>
    </div>

    <div id="pdfWrapper">
        <canvas id="displayCanvas"></canvas>
        <div id="selectionBox"></div>
    </div>

    <div class="controls">
        <div>
            <label style="font-size:12px;">‡∏´‡∏±‡πà‡∏ô‡∏Å‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô:</label>
            <input type="number" id="splitCount" value="2" min="1" max="5" style="width:90%; padding:5px;">
        </div>
        <div>
            <label style="font-size:12px;">‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏£‡∏≠‡∏ö:</label>
            <input type="range" id="boxHeightInput" min="50" max="1000" value="300">
        </div>
    </div>

    <button class="btn-process" onclick="processUltraSharp()">1. ‡∏ï‡∏±‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î</button>
    <button id="shareBtn" class="btn-share" onclick="shareToPrinter()">2. ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ / ‡πÅ‡∏ä‡∏£‡πå</button>

    <div id="status" style="margin-top:10px; font-weight:bold; color:#007bff;"></div>
    <canvas id="previewCanvas"></canvas>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    
    let currentPdf = null;
    let displayCanvas = document.getElementById('displayCanvas');
    let selectionBox = document.getElementById('selectionBox');
    let finalBlob = null;
    let displayScale = 1.0;

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (Touch & Mouse) ---
    let isDragging = false;
    let startY, startTop;

    const startDrag = (e) => {
        isDragging = true;
        startY = e.clientY || e.touches[0].clientY;
        startTop = selectionBox.offsetTop;
    };
    const moveDrag = (e) => {
        if (!isDragging) return;
        const clientY = e.clientY || e.touches[0].clientY;
        let newTop = startTop + (clientY - startY);
        newTop = Math.max(0, Math.min(newTop, displayCanvas.offsetHeight - selectionBox.offsetHeight));
        selectionBox.style.top = newTop + "px";
        if(e.cancelable) e.preventDefault();
    };
    const endDrag = () => isDragging = false;

    selectionBox.addEventListener('mousedown', startDrag);
    selectionBox.addEventListener('touchstart', startDrag);
    window.addEventListener('mousemove', moveDrag);
    window.addEventListener('touchmove', moveDrag, {passive: false});
    window.addEventListener('mouseup', endDrag);
    window.addEventListener('touchend', endDrag);

    document.getElementById('boxHeightInput').oninput = function() {
        selectionBox.style.height = this.value + "px";
    };

    // --- ‡πÇ‡∏´‡∏•‡∏î PDF ---
    document.getElementById('fileInput').onchange = async function() {
        const file = this.files[0];
        if (!file) return;
        const arrayBuffer = await file.arrayBuffer();
        currentPdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        const page = await currentPdf.getPage(1);
        
        // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏±‡∏î‡∏°‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏∑‡πà‡∏ô)
        const viewport = page.getViewport({ scale: 1.2 });
        displayScale = 1.2;
        displayCanvas.width = viewport.width;
        displayCanvas.height = viewport.height;
        await page.render({ canvasContext: displayCanvas.getContext('2d'), viewport: viewport }).promise;

        document.getElementById('pdfWrapper').style.display = "inline-block";
        document.getElementById('status').innerText = "‡∏ß‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏î‡∏á‡∏ó‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£";
    };

    // --- ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏ö‡∏ö Ultra Sharp ---
    async function processUltraSharp() {
        if (!currentPdf) return;
        const status = document.getElementById('status');
        const splitCount = parseInt(document.getElementById('splitCount').value);
        status.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏á (600 DPI)...";

        const page = await currentPdf.getPage(1);
        
        // **‡∏à‡∏∏‡∏î‡∏ï‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î: ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà Scale 6.0**
        const hdScale = 6.0;
        const hdViewport = page.getViewport({ scale: hdScale });
        const hdCanvas = document.createElement('canvas');
        const hdCtx = hdCanvas.getContext('2d', { alpha: false });
        hdCanvas.width = hdViewport.width;
        hdCanvas.height = hdViewport.height;

        await page.render({ 
            canvasContext: hdCtx, 
            viewport: hdViewport,
            intent: 'print'
        }).promise;

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Crop ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ HD
        const ratio = hdScale / displayScale;
        const cropY = selectionBox.offsetTop * ratio;
        const cropH = selectionBox.offsetHeight * ratio;
        const cropW = hdCanvas.width;

        // ‡∏´‡∏±‡πà‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ô‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô
        const partW = cropW;
        const partH = cropH / splitCount;

        const resultCanvas = document.getElementById('previewCanvas');
        const rCtx = resultCanvas.getContext('2d');
        resultCanvas.width = partH;
        resultCanvas.height = partW * splitCount;

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Smoothing ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πä‡∏∞
        rCtx.imageSmoothingEnabled = true;
        rCtx.imageSmoothingQuality = 'high';

        for (let i = 0; i < splitCount; i++) {
            const piece = document.createElement('canvas');
            const pCtx = piece.getContext('2d');
            piece.width = partH;
            piece.height = partW;
            
            pCtx.translate(piece.width/2, piece.height/2);
            pCtx.rotate(-90 * Math.PI / 180);
            pCtx.drawImage(hdCanvas, 0, cropY + (i * partH), partW, partH, -partW/2, -partH/2, partW, partH);

            rCtx.drawImage(piece, 0, i * partW);
        }

        resultCanvas.toBlob((blob) => {
            finalBlob = blob;
            status.innerText = "‚úÖ ‡∏Ñ‡∏°‡∏Å‡∏£‡∏¥‡∏ö! ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á";
            resultCanvas.style.display = "inline-block";
            document.getElementById('shareBtn').style.display = "block";
        }, 'image/png', 1.0);
    }

    async function shareToPrinter() {
        const file = new File([finalBlob], "label_hd.png", { type: "image/png" });
        if (navigator.share) {
            await navigator.share({ files: [file], title: 'Print Label HD' });
        } else {
            const link = document.createElement('a');
            link.download = "label_hd.png";
            link.href = URL.createObjectURL(finalBlob);
            link.click();
        }
    }
</script>

</body>
</html>
